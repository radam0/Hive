with_dist_cnt AS ( select COUNT(DISTINCT cusp_n) OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
								) cusp_cnt
from cmpl_stageload.stg_oroa_audt_orders
group by ord_id,
ord_juln_d,
fbsi_brch_c,
fbsi_base_c,
cusp_n )
SELECT
	c.ord_audt_id,
	c.replaced_ord_id,
	c.ord_stat_c,
	c.fbsi_brch_c,
	c.fbsi_base_c,
	c.cusp_n,
	c.sec_ty_c,
	c.cusp_cnt,
	c.ord_juln_d,
	c.ord_id,
	c.ord_acn_c,
	c.signon_rp_c,
	c.eca_prcs_n,
	c.eca_orig_prcs_n,
	c.eca_orig_ord_n,
	c.eca_usr_id,
	c.ent_rp_usr_id,
	c.part_n,
	c.multi_co_n,
	c.first_ent_rp_usr_id,
	c.first_signon_rp_c,
	CASE
			WHEN c.first_signon_rp_c IS NULL THEN c.first_signon_rp_usr_id
			ELSE d.ent_rp_usr_id
		END
	AS corr_ent_rp_usr_id,
	c.first_orig_ord_q,
	c.last_lmtp_a,
	c.first_ord_entr_tmst,
	c.cap_tmst	
FROM
	(
		SELECT DISTINCT
				a.ord_audt_id,
				a.replaced_ord_id,
				a.ord_stat_c,
				a.fbsi_brch_c,
				a.fbsi_brch_c,
				a.cusp_n,
				a.sec_ty_c,
				a.cusp_cnt,
				a.ord_juln_d,
				a.ord_id,
				a.ord_acn_c,
				a.signon_rp_c,
				a.eca_prcs_n,
				a.eca_orig_prcs_n,
				a.eca_orig_ord_n,
				a.eca_usr_id,
				a.ent_rp_usr_id,
				a.part_n,
				a.multi_co_n,
				a.first_ent_rp_usr_id,
				a.first_signon_rp_c,
				a.first_orig_ord_q,
				a.last_lmtp_a,
				a.first_ord_entr_tmst,
				a.cap_tmst,
				b.min_cap_tmst,
				b.min_ord_audt_id
			FROM
				(
					SELECT
						ord_audt_id,
						replaced_ord_id,
						ord_stat_c,
						fbsi_brch_c,
						fbsi_brch_c,
						cusp_n,
						sec_ty_c,
						cusp_cnt,
						ord_juln_d,
						ord_id,
						ord_acn_c,
						signon_rp_c,
						eca_prcs_n,
						eca_orig_prcs_n,
						eca_orig_ord_n,
						eca_usr_id,
						ent_rp_usr_id,
						part_n,
						multi_co_n,
						first_ent_rp_usr_id,
						first_signon_rp_c,
						first_orig_ord_q,
						last_lmtp_a,
						first_ord_entr_tmst,
						cap_tmst
					FROM
						(
							SELECT
								o.ord_audt_id,
								o.replaced_ord_id,
								o.ord_stat_c,
								o.fbsi_brch_c,
								o.fbsi_brch_c,
								o.cusp_n,
								o.sec_ty_c,
								o.ord_juln_d,
								o.ord_id,
								o.ord_acn_c,
								o.signon_rp_c,
								o.eca_prcs_n,
								o.eca_orig_prcs_n,
								o.eca_orig_ord_n,
								o.eca_usr_id,
								o.ent_rp_usr_id,
								o.part_n,
								o.multi_co_n,
								FIRST_VALUE(o.ent_rp_usr_id) IGNORE NULLS OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
									RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
								) AS first_ent_rp_usr_id,
								FIRST_VALUE(o.signon_rp_c) IGNORE NULLS OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
									RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
									) first_signon_rp_c,
								FIRST_VALUE(o.orig_ord_q) IGNORE NULLS OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
									RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
									) first_orig_ord_q,
								LAST_VALUE(o.lmtp_a) IGNORE NULLS OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
									RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
								) last_lmtp_a,
								FIRST_VALUE(o.ord_entr_tmst) IGNORE NULLS OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
									RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
								) first_ord_entr_tmst,
								o.cap_tmst,
								cn.cusp_cnt,
								ROW_NUMBER() OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c
									ORDER BY
										cap_tmst,
										ord_audt_id
								) rn	
							FROM
								cmpl_stageload.stg_oroa_audt_orders	o INNER JOIN with_dist_cnt cn on (cn.ord_id=o.ord_id,
																									cn.ord_juln_d=o.ord_juln_d
																									cn.fbsi_brch_c=o.fbsi_brch_c
																									cn.fbsi_base_c=o.fbsi_base_c)
								INNER JOIN cmpl_stageload.stg_oroa_audt_orders_cncl ON nvl(o.ord_stat_c,'z') NOT IN (
									'$$ORD_STATUS1',
									'$$ORD_STATUS2'
								)
								
																						AND o.ord_id = cncl.ord_id
																						AND o.ord_juln_d = cncl.ord_juln_d
																						AND o.fbsi_brch_c = o.fbsi_brch_c
																						AND o.fbsi_base_c = cncl.fbsi_base_c
						)
					WHERE
						rn = 1
				) a 
						LEFT OUTER JOIN (
							SELECT	
								corr.ord_id,
								corr.ord_juln_d,
								corr.fbsi_brch_c,
								corr.fbsi_base_c,
								corr.signon_rp_c,
								corr.ord_stat_c,
								corr.ent_rp_usr_id
								MIN(corr.cap_tmst) OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c,
									signon_rp_c
								) AS min_cap_tmst,
								MIN(corr.ord_audt_id) OVER(
									PARTITION BY ord_id,
									ord_juln_d,
									fbsi_brch_c,
									fbsi_base_c,
									signon_rp_c
								) AS min_ord_audt_id,
							FROM
								cmpl_stageload.stg_oroa_audt_orders corr 
								INNER JOIN cmpl_stageload.stg_oroa_audt_orders_cncl1 ON nvl(corr.ord_stat_c,'z') NOT IN (
									'$$ORD_STATUS1',
									'$$ORD_STATUS2'
								)
								
																						AND corr.signon_rp_c IS NOT NULL
																						AND corr.ord_id = cncl1.ord_id 
																						AND corr.ord_juln_d = cncl1.ord_juln_d
																						AND corr.fbsi_brch_c = cncl1.fbsi_brch_c
																						AND corr.fbsi_base_c = cncl1.fbsi_base_c
						) b ON a.ord_id = b.ord_id
								AND a.ord_juln_d = b.ord_juln_d
								AND a.fbsi_brch_c = b.fbsi_brch_c
								AND nvl(a.ord_stat_c,'z') = nvl(b.ord_stat_c,'z') 
	) c
	LEFT OUTER JOIN cmpl_stageload.stg_oroa_audt_orders d ON nvl(d.ord_stat_c,'z') NOT IN (
		'$$ORD_STATUS1',
		'$$ORD_STATUS2'
	)															
																AND c.ord_id = d.ord_id 
																AND c.ord_juln_d = d.ord_juln_d
																AND c.fbsi_brch_c = d.fbsi_brch_c
																AND c.fbsi_base_c = d.fbsi_base_c
																AND c.min_cap_tmst = d.min_cap_tmst
																AND c.min_ord_audt_id = d.ord_audt_id
